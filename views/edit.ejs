<!DOCTYPE html>
<html>
<head>
  <title>論文管理-論文情報編集</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body>

  <div id="header"></div>
  <script>
  fetch('/header.html')
    .then(response => response.text())
    .then(data => document.getElementById('header').innerHTML = data);
  </script>

  <h1>論文を編集</h1>
    <form method="POST" action="/edit/<%= id %>" enctype="multipart/form-data">
      <input name="title" value="<%= paper.title %>" required /><br />
      <textarea name="summary" required><%= paper.summary %></textarea><br />
      <input name="link" value="<%= paper.link %>" /><br />
      <label>PDFファイル:</label>
        <input type="file" name="pdfFile" accept="application/pdf" /><br />

      <label>既存タグ（複数選択可）:</label><br />
      <input type="text" id="tagSearch" placeholder="タグを検索..." style="width: 100%; margin-bottom: 5px;" />
      <div id="tagsCheckbox" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; max-height: 200px; overflow-y: auto;">
        <% 
          let paperTags = [];
          try { paperTags = JSON.parse(paper.tags || '[]'); } catch(e) { paperTags = paper.tags ? paper.tags.split(',').map(s=>s.trim()) : []; }
        %>
        <% tags.forEach(t => { %>
          <div class="tag-checkbox-item" data-tag="<%= t %>">
            <input type="checkbox" name="tags" value="<%= t %>" id="tag_<%= t.replace(/\s+/g, '_') %>" <%= paperTags.includes(t) ? 'checked' : '' %> />
            <label for="tag_<%= t.replace(/\s+/g, '_') %>" style="margin-left: 5px; cursor: pointer;"><%= t %></label>
          </div>
        <% }) %>
      </div>
      <label>新しいタグ（カンマ区切り）:</label>
      <input type="text" name="newTags" placeholder="例: IDS, セキュリティ" />
      <br />
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const tagSearch = document.getElementById('tagSearch');
          const tagsCheckbox = document.getElementById('tagsCheckbox');
          
          if (!tagSearch || !tagsCheckbox) return;
          
          tagSearch.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            const items = tagsCheckbox.querySelectorAll('.tag-checkbox-item');
            items.forEach(item => {
              const tagName = item.dataset.tag.toLowerCase();
              const matches = tagName.includes(query);
              item.style.display = matches ? '' : 'none';
            });
          });
        });
      </script>

      <button type="submit">保存</button>
    </form>

    <!-- タグは上のセレクトと新規タグ入力で扱います -->

<div id="footer"></div>
<script>
fetch('/footer.html')
  .then(response => response.text())
  .then(data => document.getElementById('footer').innerHTML = data);
</script>
<script src="/search.js"></script>

</body>
</html>
